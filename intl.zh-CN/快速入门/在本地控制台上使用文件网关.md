# 在本地控制台上使用文件网关

本文介绍如何在本地文件网关控制台上完成共享设置。

1.  已注册阿里云账号，并完成实名认证，详情请参见[创建阿里云账号](https://www.alibabacloud.com/help/zh/doc-detail/50482.html)。

    **说明：** 建议您使用RAM账户登录云存储网关控制台进行相关操作，详情请参见[账号访问控制](/intl.zh-CN/最佳实践/账号访问控制.md)。

2.  已开通云存储网关服务。

    首次登录时，根据页面提示开通云存储网关服务。

3.  已部署本地文件网关控制台，详情请参见[部署本地文件网关控制台](/intl.zh-CN/本地控制台用户指南/文件网关/部署本地文件网关控制台.md)。
4.  已创建OSS Bucket，详情请参见[创建存储空间](/intl.zh-CN/快速入门/控制台快速入门/创建存储空间.md)。

    **说明：**

    -   云存储网关支持标准（Standard）类型、低频访问（IA）类型和归档存储类型的OSS Bucket。
    -   对于归档文件，如果在创建共享时未开启归档支持功能，则在进行读操作时需要先手动解冻文件。
5.  已添加磁盘，详情请参见[添加磁盘](/intl.zh-CN/本地控制台用户指南/文件网关/添加磁盘.md)。

## 步骤一：添加缓存

文件存储网关的每个共享目录都对应唯一一个缓存盘，创建多个共享目录则需要创建多个缓存盘。您可以将共享目录下的数据通过缓存盘传至阿里云OSS，也可以通过缓存盘将阿里云OSS数据同步到本地。

1.  在浏览器中，输入`https://<文件网关IP地址>`访问本地文件网关控制台。

2.  输入用户名和密码，单击**确认**。

3.  选择**缓存设置**页面，单击**创建**。

4.  在创建缓存对话框中，完成如下配置。

    -   **硬盘**：单击**选择**，选择可用的硬盘。

        在部署平台添加磁盘后，此处才有可用的硬盘，详情请参见[添加磁盘](/intl.zh-CN/本地控制台用户指南/文件网关/添加磁盘.md)。

    -   **文件系统**：可选。勾选此选项，可重用该缓存盘中的数据。如果您误删共享后，可重建共享并使用缓存盘的数据重用功能进行数据恢复。

        **说明：** 如果缓存上没有文件系统，勾选重用选项，会创建缓存失败。

5.  单击**确认**，完成添加。


## 步骤二：绑定云资源

创建以OSS Bucket为存储后端的共享资源，一个Bucket对应一个共享资源。文件存储网关支持创建多个云资源。

**说明：** 通过客户端写入云存储网关的数据默认实时上传到OSS Bucket，也可在创建共享时设置延时上传，最大延时可支持设置为120s。

1.  在本地文件网关控制台中，选择**云资源设置**页面，单击**绑定**。

2.  在绑定云资源对话框中，完成如下配置。

    |参数|说明|
    |--|--|
    |**资源名称**|设置云资源名称。|
    |**跨域绑定**|    -   选择**是**，可访问与文件网关不同地域的OSS Bucket。
    -   选择**否**，只能访问与文件网关相同地域的Bucket。
 **说明：** 本地文件网关的时区必须与OSS Bucket的时区保持一致。 |
    |**区域**|选择Bucket所在区域。|
    |**Bucket名称**|选择要绑定的Bucket。|
    |**使用SSL**|如果选择**是**，可使用SSL访问OSS Bucket。|

3.  单击**确认**，完成云资源的绑定。


## 步骤三：创建共享

本地文件网关支持NFS共享和SMB共享，您可以根据需求进行选择。此处以创建NFS共享为例进行说明，如果您要创建SMB共享，详情请参见[管理SMB共享](/intl.zh-CN/本地控制台用户指南/文件网关/管理SMB共享.md)。

1.  安装NFS客户端，详情请参见[安装NFS客户端](/intl.zh-CN/本地控制台用户指南/文件网关/管理NFS共享.md)。

2.  返回本地文件网关控制台，选择**NFS**页面，单击**创建**。

3.  在创建NFS对话框中，完成如下配置，并单击**确认**。

    |参数|说明|
    |--|--|
    |**共享名称**|NFS协议的虚拟挂载点。 NFSv4可以通过该名称直接挂载；NFSv3需要通过`showmount -e <网关IP地址>`获取挂载点。 |
    |**读写客户端列表**|允许读写访问NFS网关的IP地址或网段。 例如192.168.10.10或192.168.0.0/24，允许输入多个IP地址或者网段。 |
    |**只读客户端列表**|允许只读访问NFS网关的IP地址或网段。 例如192.168.10.10或192.168.0.0/24，允许输入多个IP地址或者网段。 |
    |**用户映射**|设置NFS客户端用户与NFS服务器用户之间的映射关系，仅当**协议**类型选择**NFS**时需要配置。

     -   none：NFS客户端用户不被映射为NFS服务器的nobody用户。
    -   root\_squash：限制root用户，当NFS客户端以root用户身份访问时，映射为NFS服务器的nobody用户。
    -   all\_squash：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的nobody用户。
    -   all\_anonymous：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的匿名用户。 |
    |**归档支持**|    -   选择**是**，开启归档支持功能。在已归档的文件上发起读操作请求时同步发起解冻请求，请求不会报错，但存在一定的时间延迟。
    -   选择**否**，关闭归档支持功能。在已归档的文件上发起读操作请求时，需先手动解冻文件，否则请求会报错。
 **说明：** 基础型文件网关不支持**归档支持**功能。 |
    |**启用**|启用NFS共享。 如果您暂时不想使用该NFS共享，您可以选择**否**，关闭该NFS共享。 |
    |**模式**|包括缓存模式和复制模式。     -   **复制模式**：所有数据都会保存两份拷贝，一份保存在本地缓存，另一份保存在OSS。
    -   **缓存模式**：本地缓存全量元数据和经常访问的用户数据。OSS侧保持全量数据。 |
    |**反向同步**|将OSS上的元数据同步回本地。适用于网关容灾和数据恢复/共享场景。 **说明：** 反向同步会扫描Bucket下的所有对象，如果对象数量较多，会产生OSS API请求费用。具体费用，请参见[对象存储 OSS 详细价格信息](https://www.aliyun.com/price/product?spm=a2c4g.11186623.2.26.18277b55Ki5BVd#/oss/detail)中的请求费用。 |
    |**加密类型**|包括**不加密**和**服务端加密**。 如果选择**服务端加密**，还需设置**密钥ID**。您可以在[密钥管理服务控制台](https://kms.console.aliyun.com/)中创建密钥，详情请参见[创建密钥]()。

 开启OSS服务端加密后，允许用户自带密钥，目前支持从密钥管理服务中导入KMS密钥。

 开启服务端加密后，通过共享目录上云的文件会在OSS端自动利用KMS密钥进行加密。您可以通过Get Object API验证当前文件是否已经加密，如果返回的Header中x-oss-server-side-encryption字段值为KMS，x-oss-server-side-encryption-key-id字段值为密钥ID，则表示已加密。

 **说明：**

    -   白名单用户才能使用此功能。
    -   在密钥管理服务控制台创建密钥时，需选择与OSS Bucket一样的区域。 |
    |**Bucket名称**|选择已创建的Bucket。|
    |**子目录**|输入Bucket下的子目录。 子目录只支持英文和数字。

 **说明：** 从1.0.38版本开始支持将文件系统的根目录对接到OSS Bucket的某个子目录，便于用户做访问隔离。

子目录可以为OSS Bucket中已存在的目录也可以为OSS Bucket中还未创建的目录，创建共享完成后，将以该子目录为根目录，后续的文件和目录都会创建该目录下。 |
    |**使用元数据盘**|使用元数据盘后，将数据盘与元数据盘分离，元数据盘用于存放共享文件夹元数据信息。     -   选择**是**，需选择对应的**元数据盘**和**数据盘**。
    -   选择**否**，需选择对应的**缓存硬盘**。
 **说明：** 白名单用户才能使用此功能。 |
    |**忽略删除**|文件删除操作不同步至OSS防止误操作。OSS侧保持全量数据。|
    |**NFS V4优化**|提升NFS V4挂载时的上传效率。打开该选项后，不再支持以NFS V3方式挂载。|
    |**同步延迟**|设置**同步延迟**，在关闭文件会延迟一段时间再上传，防止频繁的本地修改操作造成OSS碎片。缺省值为5s，最大值120s。|
    |**最大写入速度**|允许的最大写入速度为1280MB/s。默认为0，表示不限制速度。|
    |**最大上传速度**|允许的最大上传速度为1280MB/s。默认为0，表示不限制速度。 **说明：** 在限制速度的情况下，最大上传速度不能小于最大写入速度。 |
    |**碎片优化**|针对某些反复随机小IO读写的应用，启用此配置可提升性能，请根据场景谨慎选择。|
    |**上传优化**|实时缓存回收，适用于数据纯备份上云场景。|

4.  单击**确认**，完成共享的创建。

5.  创建完成后，您可以通过NFS客户端访问共享目录，详情请参见[访问NFS共享目录](/intl.zh-CN/本地控制台用户指南/文件网关/访问共享目录/访问NFS共享目录.md)。


