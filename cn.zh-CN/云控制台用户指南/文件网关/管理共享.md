# 管理共享

本文介绍如何在云存储网关控制台上管理共享，包括创建共享、设置NFS共享、设置SMB共享、删除共享等操作。

1.  已创建云存储网关。更多信息，请参见[创建文件网关](/cn.zh-CN/云控制台用户指南/文件网关/管理文件网关.md)。
2.  已添加缓存，详情请参见[添加缓存](/cn.zh-CN/云控制台用户指南/文件网关/管理缓存.md)。
3.  已创建OSS Bucket，详情请参见[创建存储空间](/cn.zh-CN/快速入门/控制台快速入门/创建存储空间.md)。

    **说明：**

    -   云存储网关支持标准（Standard）类型、低频访问（IA）类型和归档存储类型的OSS Bucket。
    -   对于归档文件，如果在创建共享时未开启归档支持功能，则在进行读操作时需要先手动解冻文件。

## 创建共享

1.  登录[云存储网关控制台](https://sgwnew.console.aliyun.com/)。

2.  选择目标文件网关所在的地域。

3.  在网关列表页面，找到并单击目标文件网关，进入操作页面。

4.  选择共享页签，单击**创建**。

5.  在Bucket设置页签中，完成如下配置并单击**下一步**。

    |参数|说明|
    |--|--|
    |**跨域绑定**|    -   选择**是**，可访问与云存储网关不同地域的Bucket。
    -   选择**否**，只能访问与云存储网关相同地域的Bucket。 |
    |**Bucket区域**|选择Bucket区域。|
    |**Bucket名称**|选择已创建的Bucket或者输入Bucket下的子目录。 子目录只支持英文和数字。

**说明：**

    -   从1.0.38版本开始支持将文件系统的根目录对接到OSS Bucket的某个子目录，便于用户做访问隔离。
    -   子目录可以为OSS Bucket中已存在的目录也可以为OSS Bucket中还未创建的目录，创建共享完成后，将以该子目录为根目录，后续的文件和目录都会创建该目录下。 |
    |**加密**|包括**不加密**和**服务端加密**。 如果选择**服务端加密**，还需设置**密钥ID**。您可以在[密钥管理服务控制台](https://kms.console.aliyun.com/)中创建密钥，详情请参见[创建密钥]()。

开启OSS服务端加密后，允许用户自带密钥，目前支持从密钥管理服务中导入KMS密钥。

开启服务端加密后，通过共享目录上云的文件会在OSS端自动利用KMS密钥进行加密。您可以通过Get Object API验证当前文件是否已经加密，如果返回的Header中x-oss-server-side-encryption字段值为KMS，x-oss-server-side-encryption-key-id字段值为密钥ID，则表示已加密。

**说明：**

    -   白名单用户才能使用此功能。
    -   在密钥管理服务控制台创建密钥时，需选择与OSS Bucket一样的区域。 |
    |**使用SSL连接Bucket**|如果选择**是**，则可通过SSL连接Bucket。|

6.  在**基本信息**页签中，完成如下配置并单击**下一步**。

    |参数|说明|
    |--|--|
    |**共享名称**|NFS或者SMB的共享名称。如果选择**NFS**协议，则此共享名称也是NFS v4的虚拟路径。不能以数字开头，不能超过32个字符，可以为英文或者数字。 |
    |**协议**|根据业务需求，选择NFS或者SMB。    -   NFS协议适用于在Linux系统中对挂载的OSS资源进行访问
    -   SMB协议适用于在Windows系统中对挂载的OSS资源进行访问。 |
    |**缓存**|选择已创建的缓存盘。**说明：** 5TB以下缓存盘，其20%的空间用于存放元数据；5TB以上的存储盘，1TB用于存放元数据。例如：创建40G的缓存盘，其实际可使用的缓存大小为32G。创建20TB的缓存盘，其实际可使用的缓存大小为19TB。 |
    |**用户映射**|设置NFS客户端用户与NFS服务器用户之间的映射关系，仅当**协议**类型选择**NFS**时可以配置。

    -   none：NFS客户端用户不被映射为NFS服务器的nobody用户。
    -   root\_squash：限制root用户，当NFS客户端以root用户身份访问时，映射为NFS服务器的nobody用户。
    -   all\_squash：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的nobody用户。
    -   all\_anonymous：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的匿名用户。 |
    |**归档支持**|仅当**协议**类型选择**NFS**时可以配置。    -   选择**是**，开启归档支持功能。在已归档的文件上发起读操作请求时同步发起解冻请求，请求不会报错，但存在一定的时间延迟。
    -   选择**否**，关闭归档支持功能。在已归档的文件上发起读操作请求时，需先手动解冻文件，否则请求会报错。
**说明：** 基础型文件网关不支持**归档支持**功能。 |
    |**加入同步组**|开启该共享的极速同步功能，将其加入同步组，对该共享的Bucket中数据进行的任何改动都会自动同步至共享的本地客户端。开启该选项后，该共享的反向同步选项将自动关闭。**说明：**

    -   要选择该选项，您必须提前创建一个同步组，且同步组的Bucket必须与共享的Bucket相同。有关创建同步组的更多信息，请参见[极速同步](/cn.zh-CN/云控制台用户指南/文件网关/极速同步.md)。
    -   目前只有标准型、增强型及性能型的云存储网关支持极速同步功能。
    -   极速同步功能依赖于阿里云消息服务MNS实现，因此将共享加入同步组会产生MNS服务的费用。计费更多信息，请参见[极速同步](/cn.zh-CN/云控制台用户指南/文件网关/极速同步.md)背景信息中的说明。 |
    |**高级设置**|选中**高级设置**后，出现**高级设置**配置页。|

7.  在**高级设置**页签中，完成如下配置并单击**下一步**。

    |参数|说明|
    |--|--|
    |**模式**|    -   **复制模式**：所有数据都会保存两份拷贝，一份保存在本地缓存，另一份保存在OSS。
    -   **缓存模式**：本地缓存全量元数据和经常访问的用户数据。OSS侧保持全量数据。 |
    |**传输加速**|传输加速会提高跨域情况下的数据传输速度，充分利用网关的公网带宽，使用前请确保正在使用的OSS Bucket已开启了传输加速。|
    |**碎片优化**|针对某些反复随机小IO读写的应用，启用此配置可提升性能，请根据场景谨慎选择。|
    |**Direct IO模式**|使用直接I/O方式进行数据传输。|
    |**上传优化**|实时缓存回收，适用于数据纯备份上云场景。|
    |**反向同步**|将OSS上的元数据同步回本地。适用于网关容灾和数据恢复/共享场景。**说明：**

    -   反向同步会扫描Bucket下的所有对象，如果对象数量较多，会产生OSS API请求费用。具体费用，请参见[对象存储OSS详细价格信息](https://www.aliyun.com/price/product?spm=a2c4g.11186623.2.26.18277b55Ki5BVd#/oss/detail)中的请求费用。
    -   如果您在**基本信息**页签中选中了**加入同步组**，则此选项不可用。 |
    |**反向同步时间间隔**|设置**反向同步**为**是**，可设置**反向同步时间间隔**。支持15 s-36000 s的反向同步间隔，默认值为36000 s。**说明：**

    -   如果Bucket内的对象比较多，建议反向同步间隔大于3600 s，否则会由于反复扫描产生大量的OSS API的请求费用。
    -   如果共享使用了缓存模式并使用数据下载的情况下，反向同步的可设置时间间隔最小为3600 s，最大为36000 s。 |
    |**忽略删除**|文件删除操作不同步至OSS防止误操作。OSS侧保持全量数据。|
    |**NFS V4 优化**|提升NFS v4挂载时的上传效率。打开该选项后，不再支持以NFS v3方式挂载。|
    |**同步延迟**|设置**同步延迟**，在关闭文件会延迟一段时间再上传，防止频繁的本地修改操作造成OSS碎片。默认值为5 s，最大值120 s。|
    |**复制模式高级设置**|当**模式**选择**复制模式**时，可以选择**复制模式高级设置**，出现**复制模式高级设置**配置页。|

8.  在**复制模式高级设置**页签中，完成如下配置并单击**下一步**。

    |参数|说明|
    |--|--|
    |**配置复制目录**|配置复制模式的文件数据范围：    -   未勾选时，默认共享全量数据运行在复制模式。
    -   选中时，在配置页面单击**添加目录**，输入目标数据目录路径。指定目录路径数据运行在复制模式，未指定部分数据运行在缓存模式。
**说明：**

    -   当更改目录从缓存模式变成复制模式时，目录中的文件只有在开启数据下载时才会被同步。推荐您同时开启数据下载。
    -   指定目录路径为基于共享根目录的相对路径。例如，需要开启复制模式的目录的真实路径为/mnt/myshare/mydir/，其中/mnt/myshare为挂载点，那么填入/mydir/即可。 |
    |**数据下载**|反向同步或极速同步默认会同步元数据，使用数据下载可以下载指定路径目录文件数据或全量数据至本地客户端。当开启**反向同步**或开启[极速同步](/cn.zh-CN/云控制台用户指南/文件网关/极速同步.md)时，可以选择**是**开启**数据下载**。**说明：**

    -   数据下载要求缓存盘容量大于所需复制文件总大小的1.1倍，请根据Bucket使用量的增长预期，合理规划缓存盘容量大小。
    -   初次开启数据下载时，会触发一次全量扫描，可能会对性能产生影响，请确保开启数据下载时，网关处于空闲状态，直到完成所有数据下载。
    -   数据下载只支持一写多读的情况。如果对应的Bucket有多个访问者（包括并不局限于网关、直接OSS访问），只允许一个访问者上传文件到Bucket，其他访问者只能下载。多写多读情况下可能造成数据丢失，请您慎用。 |
    |**下载速度限制**|当开启**数据下载**时配置此项，下载速度限制不小于0 MB/s，且不大于1280 MB/s，当设置为0 MB/s即不限速。|
    |**反向同步时间间隔**|当开启**数据下载**时配置此项，支持3600 s-36000 s的反向同步间隔，默认值为36000 s。 **说明：**

    -   如果Bucket内的对象比较多，建议反向同步间隔大于3600 s，否则会由于反复扫描产生大量的OSS API的请求费用。
    -   由于反向同步只在访问目录时触发，为确保未访问目录中的数据能下载，以及确保新增数据能及时下载，推荐您使用极速同步。更多信息，请参见[极速同步](/cn.zh-CN/云控制台用户指南/文件网关/极速同步.md)。 |

9.  在**总结**页签中，确认信息无误后，单击**完成**。


## 设置NFS共享

如果创建共享时选择**NFS**协议，则单击**设置**可设置NFS共享信息。

1.  在共享页面，找到目标共享，单击**设置**。

2.  在NFS共享设置对话框中，配置相关信息。

    |参数|说明|
    |--|--|
    |**用户映射**|设置NFS客户端用户与NFS服务器用户之间的映射关系。    -   none：NFS客户端用户不被映射为NFS服务器的nobody用户。
    -   root\_squash：限制root用户，当NFS客户端以root用户身份访问时，映射为NFS服务器的nobody用户。
    -   all\_squash：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的nobody用户。
    -   all\_anonymous：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的匿名用户。 |
    |**读写客户端列表**|允许读写访问NFS网关的IP地址或网段。例如192.168.10.10或192.168.0.0/24，允许输入多个IP地址或者网段。 |
    |**只读客户端列表**|允许只读访问NFS网关的IP地址或网段。例如192.168.10.10或192.168.0.0/24，允许输入多个IP地址或者网段。 |
    |**写入速度限制**|允许的最大写入速度为1280 MB/s。默认为0，表示不限制速度。|
    |**上传速度限制**|允许的最大上传速度为1280 MB/s。默认为0，表示不限制速度。**说明：** 在限制速度的情况下，最大上传速度不能小于最大写入速度。 |


## 设置SMB共享

如果创建共享时选择**SMB**协议，则单击**设置**可设置SMB共享信息。

1.  在共享页面，找到目标共享，单击**设置**。

2.  在SMB共享设置对话框中，配置相关信息。

    |参数|说明|
    |--|--|
    |**可浏览**|可在网络邻居中被发现。|
    |**读写权限用户**|允许读写访问SMB网关的用户列表。|
    |**只读权限用户**|允许只读访问SMB网关的用户列表。**说明：** 如果只读用户同时出现在读写用户列表中，该用户只有只读权限。 |
    |**写入速度限制**|允许的最大写入速度为1280 MB/s。默认为0，表示不限制速度。|
    |**上传速度限制**|允许的最大上传速度为1280 MB/s。默认为0，表示不限制速度。**说明：** 在限制速度的情况下，最大上传速度不能小于最大写入速度。 |


## 其他操作

在共享列表页面，您可以进行如下操作。

|操作|说明|
|--|--|
|修改高级设置|找到目标共享，单击**高级共享**，可修改高级设置。高级设置参数说明，请参见[创建共享](#section_qgs_5th_jol)。|
|删除共享|找到目标共享，单击**删除**，可删除共享。**说明：**

-   删除共享，不会删除OSS上的数据。
-   删除共享，不会释放缓存盘，也不会删除缓存盘上的数据。
-   再次创建共享时需要重新绑定缓存盘和OSS Bucket。 |
|重启NFS共享|单击**重启NFS共享**，可重启该网关下所有的NFS共享。|
|重启SMB共享|单击**重启SMB共享**，可重启该网关下所有的SMB共享。|
|隐藏任务|单击**隐藏任务**，可隐藏页面下方的任务列表。|
|查看上传和下载状态|单击目标共享前**＋**，您可以在网关状态中查看上传队列和下载队列的展示。-   当上传队列不为0时，说明还有任务需要上传到OSS Bucket。
-   当下载队列不为0时，说明还有下载任务需要完成。
-   上传队列和下载队列都为0时，说明本地网关已经完成了和OSS Bucket的同步。 |

[访问共享目录](/cn.zh-CN/云控制台用户指南/文件网关/访问共享目录/访问NFS共享目录.md)

