# 使用须知

为了保证云存储网关实例的正常运行，在使用之前，请您务必认真阅读以下使用须知。

## 文件网关须知

-   建议不要频繁中断大文件拷贝到NFS或SMB共享文件夹。由于后台的分段上传机制，中断大文件拷贝会造成碎片遗留在OSS。这些碎片会影响OSS的空间统计，造成OSS空间统计略大于看到的文件总量。通过OSS的碎片自动删除策略，可以帮助用户管理碎片，详情请参见[管理碎片](/cn.zh-CN/控制台用户指南/文件管理/管理碎片.md)。
-   文件共享的缓存区估算公式为：本地建议缓存容量=（应用带宽（MB/s）-网关后端带宽（MB/s））×写入时长（s）×1.2。

    如果您需要获得较好的本地访问性能，可以先预估总的热数据容量。取总的热数据容量和本地建议缓存容量的最大值为本地缓存盘容量。

-   如果使用文件网关写入较大的文件，单一文件大小应保持在缓存盘容量的30%以下，且不能多个大文件并发写入，否则容易造成缓存盘写满的情况。
-   1.0.37及之前版本的文件网关支持的最大文件大小是1.2TB。超过该值，文件将无法上传至OSS。1.0.38及之后版本的文件网关支持最大30TB的文件上传。在上传超大文件时（大于2TB），建议用户的公网带宽不低于500MB/s或者采用专线连接阿里云，否则可能出现上传超时的问题。
-   文件网关支持Sparse file。如果上传Sparse file到文件网关失败，请运行以下命令转化。

    ```
    dd if=<sparse file name> of=<sparse file name> conv=notrunc bs=1M
    ```

    目前，支持的Sparse File文件大小要求不超过可用缓存盘的大小。

-   文件网关的文件名和目录名必须使用UTF-8编码。文件网关暂不支持非UTF-8编码的文件名或目录名。例如，如果在Windows下挂载文件网关的NFS共享，那么大部分中文文件和中文目录都会创建失败，这时Windows会返回0x8007045D的错误。
-   文件网关中的单个文件超过256 MB的情况下，不建议开启Bucket的多版本功能。否则会出现文件元数据上传超时，影响网关整体性能。
-   文件网关是基于POSIX ACL实现Windows AD的权限访问隔离，不支持跨目录层级的多AD用户授权。例如：目录层级AA/BB/CC，属于用户1。此时仅授予用户2访问（读写/只读）目录CC的权限，用户2无法利用AA/BB/CC全路径直接访问CC下的数据，需要把AA和BB都对用户2授权，才能保证数据对用户2可见。

## 云上文件网关须知

-   存储网关控制台采用HTTPS协议。NFS或SMB等网络存储协议用到一些特殊的端口，需要通过防火墙或者安全组开通服务。
    -   云存储网关支持AD/LDAP域，新增需配置的端口有：LDAP、AD、DNS、Kerberos。安全组授权包括IP段和安全组授权，具体方法请参见[添加安全组规则](/cn.zh-CN/安全/安全组/添加安全组规则.md)。

        安全组授权是指在同一VPC和账号下，可以跨安全组授权。例如：将云存储网关所在安全组授权给域服务器所在安全组，另外在域服务器所在安全组中再加上2条规则：TCP 53/636和UDP 53/636即可。

    -   NFS/SMB所需的端口是在云存储网关入方向的安全组中配置，云上文件网关创建好后安全组默认配置好这些端口，无需手动配置。LDAP/AD是在域服务器所在安全组入方向的端口配置。

        |协议|端口|
        |--|--|
        |HTTPS|443，8080|
        |NFS|111（TCP、UDP），875（TCP、UDP），892（TCP、UDP），2049（TCP、UDP），32887（TCP、UDP），32888（TCP、UDP），32889（TCP、UDP）|
        |SMB|137（UDP），138（UDP），139（TCP），389（TCP），445（TCP），901（TCP）|
        |SSH|22|
        |LDAP|389（UDP，TCP），636（UDP）|
        |AD|445（TCP、UDP）|
        |DNS|53（TCP、UDP）|
        |Kerberos|88（TCP、UDP）|

-   网关同步带宽根据OSS带宽限制制定，目前OSS为每个用户提供的最大访问带宽为10 Gbps。各区域的集群略有差异，请提交[工单](https://www.aliyun.com/service?spm=5176.8465980.top-nav.dsupport.3b961450dscUYd)咨询。
-   创建云上文件网关后，会默认创建一个前缀为Cloud\_Storage\_Gateway\_Usage的安全组，创建ECS时请避免使用此安全组。
-   在OSS文件数超过百万级别后，建议设置比较大的反向同步间隔（\>3600s）。
-   从1.0.36版本开始支持按照文件后缀名自动在OSS的对象元数据里设置MIME类型。
-   在反向同步打开的情况下，在一个扫描周期中会出现本地未上云的空目录被反向同步进程删除的情况，再次创建目录即可修复。
-   默认的在线云存储网关只有1 Mb/s的公网带宽上行带宽，在跨地域访问OSS时使用的是公网，不保证传输质量和速度。

## 本地文件网关须知

-   本地文件网关需在客户端的防火墙中打开以下端口。

    |协议|端口|
    |--|--|
    |HTTPS|443|
    |NFS|111（TCP、UDP），875（TCP、UDP），892（TCP、UDP），2049（TCP、UDP），32887（TCP、UDP），32888（TCP、UDP），32889（TCP、UDP）|
    |SMB|137（UDP），138（UDP），139（TCP），389（TCP），445（TCP），901（TCP）|
    |SSH|22|
    |LDAP|389（UDP，TCP），636（UDP）|
    |AD|445（TCP、UDP）|
    |DNS|53（TCP、UDP）|
    |Kerberos|88（TCP、UDP）|


## 块网关须知

-   iSCSI卷缓存区估算格式：本地建议缓存容量=（应用带宽（MB/s）-网关后端带宽（MB/s））×写入时长（s）×1.2

    如果您需要获得较好的本地访问性能，可以先预估总的热数据容量。取总的热数据容量和本地建议缓存容量的最大值为本地缓存盘容量。

-   块网关同步带宽根据OSS带宽限制制定，目前OSS为每个用户提供的最大访问带宽为10Gbps。各区域的集群略有差异，请向各区域OSS客户支持人员查询。
-   缺省配置的IOPS受限于后端云盘的能力。高效云盘的最大带宽为110MB/s，SSD云盘的最大带宽为230MB/s。
-   块网关需在客户端的防火墙中打开以下端口。
    -   云上块网关

        |协议|端口|
        |--|--|
        |iSCSI|860（TCP）、3260（TCP）|

    -   本地块网关

        |协议|端口|
        |--|--|
        |HTTPS|443|
        |iSCSI|860（TCP）、3260（TCP）|


