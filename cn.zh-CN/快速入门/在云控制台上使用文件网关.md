# 在云控制台上使用文件网关 {#concept_108244_zh .task}

本文介绍如何通过阿里云云存储网关控制台快速创建文件网关并完成共享设置。

1.  已注册阿里云账号，并完成实名认证，详情请参见[阿里云账号注册流程](../../../../cn.zh-CN/.md#)。

    **说明：** 建议您使用RAM账户登录云存储网关控制台进行相关操作，详情请参见[账号访问控制](../../../../cn.zh-CN/最佳实践/账号访问控制.md#)。

2.  已开通云存储网关服务。

    首次登录[云存储网关控制台](https://sgwnew.console.aliyun.com/)时，根据页面提示开通云存储网关服务。

3.  在需要创建云上文件网关的地域，已有可用的专有网络VPC，详情请参见[创建专有网络和交换机](创建专有网络和交换机../../SP_22/DNVPC11885991/ZH-CN_TP_2434.dita#concept_isl_ghv_rdb/section_ufw_rhv_rdb)。
4.  在需要创建云上文件网关的地域，已有可用的云服务器ECS，并将此云服务器ECS归属到已创建的专有网络VPC下，详情请参见[创建ECS实例](../../../../cn.zh-CN/个人版快速入门/创建ECS实例.md#)。

    **说明：** 如果您的本地主机已通过专线和阿里云专有网络连通，您也可以使用本地主机进行操作。

5.  已创建OSS Bucket，详情请参见[创建存储空间](../../../../cn.zh-CN/快速入门/创建存储空间.md#)。

    **说明：** 目前文件网关支持标准（Standard）类型和低频访问（IA）类型的OSS Bucket。对于归档（Archive）类型的OSS Bucket，仅支持写操作，读操作需要先解冻。


## 步骤一：创建文件网关 {#section_id2_d9r_ou5 .section}

1.  登录[云存储网关控制台](https://sgwnew.console.aliyun.com/)。
2.  选择需要创建文件网关的地域。
3.  在网关列表页面，选择目标网关集群，单击**创建**。 如果还未创建网关集群，请在概览页面，单击**创建网关集群**，完成网关集群的创建。
4.  在**网关信息**页签中，完成如下配置并单击**下一步**。 

    |参数|说明|
    |--|--|
    |**名称**|输入网关名称。 长度为60个字符，可以包含大小写字母、中文、数字、.、\_或-，同时必须以大小写字母或者中文开头。

 |
    |**位置**|包括**本地数据中心**和**阿里云**，请根据业务需求进行选择。     -   **本地数据中心**：选择本地数据中心，则部署本地文件网关。您可以通过阿里云云存储网关控制台部署本地文件网关，也可以通过本地文件网关控制台部署本地文件网关。
    -   **阿里云**：选择本地数据中心，则部署云上文件网关。您只可以通过阿里云云存储网关控制台部署云上文件网关。
 |
    |**类型**|选择**文件网关**。|

5.  在**配置网关**页签中，完成如下配置并单击**下一步**。 

    如果**位置**选择**阿里云**，则需要配置网关信息。

    |参数|说明|
    |--|--|
    |**型号**|包括**基础型**、**标准型**、**增强型**和**性能型**，具体规格详情请参见[产品规格](../../../../cn.zh-CN/产品简介/产品规格.md#)。|
    |**专有网络**|选择所需的专有网络。 **说明：** 必须与您创建的云服务器ECS或本地主机选择一样的专有网络。

 |
    |**虚拟交换机**|选择所需的虚拟交换机。 **说明：** 必须与您创建的云服务器ECS或本地主机选择一样的虚拟交换机。

 |

6.  在**付费类型**页签中，完成如下配置，并单击**下一步**。 

    |参数|说明|
    |--|--|
    |**付费类型**|包括**按量付费**和**包年包月**，详情请参见[计量项和计费项](../../../../cn.zh-CN/计量计费/计量项和计费项.md#)。 如果选择**包年包月**，完成文件网关创建后，将跳转至购买页面，请根据页面完成付费，详情请参见[购买云存储网关](../../../../cn.zh-CN/计量计费/包年包月/购买云存储网关.md#)。

 |
    |**到期后**|包括**转后付费**和**直接回收**。|

7.  在**总结**页签中，确认信息无误后，单击**完成**。 
    -   如果您创建的是云上文件网关，则创建完成后，自动部署，大概需要5~10分钟，当状态显示为**运行中**，则表示文件网关已激活，部署完成。
    -   如果您创建的是本地文件网关，则创建完成后，还需单击**激活网关**，进行手动激活。相关参数配置请参见[激活网关](cn.zh-CN/本地控制台用户指南/文件网关/部署本地文件网关控制台.md#step_ghu_pnd_ubh)。

## 步骤二：添加缓存 {#section_wj0_f9o_wh1 .section}

**说明：** 此处介绍为云上文件网关创建缓存的步骤。本地文件网关的缓存需要在本地部署平台中创建，详情请参见[添加磁盘](../../../../cn.zh-CN/本地控制台用户指南/文件网关/添加磁盘.md#)。

1.  登录[云存储网关控制台](https://sgwnew.console.aliyun.com/)。
2.  选择目标文件网关所在的地域。
3.  在网关列表页面，找到并单击目标文件网关，进入操作页面。
4.  选择**缓存**页签，单击**创建缓存**。
5.  在添加缓存对话框中，完成如下配置。 
    -   **大小**：缓存大小需大于等于40GB，小于等于32TB。
    -   **类型**：包括**高效云盘**和**SSD**，请根据业务需求选择。
6.  单击**确认**，完成创建。 如果您创建的是包年包月的文件网关，则创建缓存后，将跳转到云存储网关缓存盘（包年包月）页面支付费用，详情请参见[购买缓存](../../../../cn.zh-CN/计量计费/包年包月/购买缓存.md#)。

## 步骤三：创建共享 {#section_udk_mtf_ro4 .section}

1.  登录[云存储网关控制台](https://sgwnew.console.aliyun.com/)。
2.  选择目标文件网关所在的地域。
3.  在网关列表页面，找到并单击目标文件网关，进入操作页面。
4.  选择共享页签，单击**创建**。
5.  在**Bucket设置**页签中，完成如下配置并单击**下一步**。 

    |参数|说明|
    |--|--|
    |**允许跨域访问Bucket**|     -   选择**是**，可访问与云存储网关不同地域的Bucket。
    -   选择**否**，只能访问与云存储网关相同地域的Bucket。
 |
    |**Bucket区域**|选择Bucket区域。|
    |**Bucket名称**|选择已创建的Bucket或者输入Bucket下的子目录。 子目录只支持英文和数字。

 **说明：** 从1.0.38版本开始支持将文件系统的根目录对接到OSS Bucket的某个子目录，便于用户做访问隔离。

子目录可以为OSS Bucket中已存在的目录也可以为OSS Bucket中还未创建的目录，创建共享完成后，将以该子目录为根目录，后续的文件和目录都会创建该目录下。

 |
    |**加密**|包括**不加密**和**服务端加密**。 如果选择**服务端加密**，还需设置**密钥ID**。您可以在[密钥管理服务控制台](https://kms.console.aliyun.com/)中创建密钥，详情请参见[创建密钥](../../../../cn.zh-CN/快速入门/管理密钥.md#section_yhn_otu_mvs)。

 开启OSS服务端加密后，允许用户自带密钥，目前支持从密钥管理服务中导入KMS密钥。

 开启服务端加密后，通过共享目录上云的文件会在OSS端自动利用KMS密钥进行加密。您可以通过Get Object API验证当前文件是否已经加密，如果返回的Header中x-oss-server-side-encryption字段值为KMS，x-oss-server-side-encryption-key-id字段值为密钥ID，则表示已加密。

 **说明：** 

    -   白名单用户才能使用此功能。
    -   在密钥管理服务控制台创建密钥时，需选择与OSS Bucket一样的区域。
 |
    |**使用SSL连接Bucket**|如果选择**是**，则可通过SSL连接Bucket。|

6.  在**基本信息**页签中，完成如下配置并单击**下一步**。 

    |参数|说明|
    |--|--|
    |**共享名称**|NFS或者SMB的共享名称。如果选择**NFS**协议，则此共享名称也是NFS v4的虚拟路径。 不能以数字开头，不能超过32个字符，可以为英文或者数字。

 **说明：** 1.0.35之前版本，如果使用NFS v3协议，则该名称无效，需要使用showmount –e <挂载网关的IP\> 查看挂载路径进行挂载。

 |
    |**协议**|根据业务需求，选择NFS或者SMB。     -   NFS协议适用于在Linux系统中对挂载的OSS资源进行访问
    -   SMB协议适用于在Windows系统中对挂载的OSS资源进行访问。
 |
    |**缓存**|选择已创建的缓存盘。 **说明：** 5TB以下缓存盘，其20%的空间用于存放元数据；5TB以上的存储盘，1TB用于存放元数据。例如：创建40G的缓存盘，其实际可使用的缓存大小为32G。创建20TB的缓存盘，其实际可使用的缓存大小为19TB。

 |
    |**用户映射**| 设置NFS客户端用户与NFS服务器用户之间的映射关系，仅当**协议**类型选择**NFS**时需要配置。

     -   none：NFS客户端用户不被映射为NFS服务器的nobody用户。
    -   root\_squash：限制root用户，当NFS客户端以root用户身份访问时，映射为NFS服务器的nobody用户。
    -   all\_squash：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的nobody用户。
    -   all\_anomnymous：限制所有用户，无论NFS客户端以何种用户身份访问，均映射为NFS服务器的匿名用户。
 |
    |**高级设置**|勾选**高级设置**后，出现**高级设置**配置页。|

7.  在**高级设置**页签中，完成如下配置并单击**下一步**。 

    |参数|说明|
    |--|--|
    |**模式**|     -   **复制模式**：所有数据都会保存两份拷贝，一份保存在本地缓存，另一份保存在OSS。
    -   **缓存模式**：本地缓存全量元数据和经常访问的用户数据。OSS侧保持全量数据。
 |
    |**碎片优化**|针对某些反复随机小IO读写的应用，启用此配置可提升性能，请根据场景谨慎选择。|
    |**上传优化**|实时缓存回收，适用于数据纯备份上云场景。|
    |**反向同步**|将OSS上的元数据同步回本地。适用于网关容灾和数据恢复/共享场景。 **说明：** 反向同步会扫描Bucket下的所有对象，如果对象数量较多，会产生OSS API请求费用。具体费用，请参见[对象存储 OSS 详细价格信息](https://www.aliyun.com/price/product?spm=a2c4g.11186623.2.26.18277b55Ki5BVd#/oss/detail)中的请求费用。

 |
    |**反向同步时间间隔**|设置**反向同步**为**是**，可设置**反向同步时间间隔**。支持15s-36000s的反向同步间隔，缺省值为36000s。 **说明：** 如果Bucket内的对象比较多，建议反向同步间隔大于3600s，否则会由于反复扫描产生大量的OSS API的请求费用。

 |
    |**忽略删除**|文件删除操作不同步至OSS防止误操作。OSS侧保持全量数据。|
    |**同步延迟**|设置**同步延迟**，在关闭文件会延迟一段时间再上传，防止频繁的本地修改操作造成OSS碎片。缺省值为5s，最大值120s。|

8.  在**总结**页签中，确认信息无误后，单击**完成**。
9.  创建完成后，您可以通过客户端访问共享目录，详情请参见[访问共享目录](cn.zh-CN/云控制台用户指南/文件网关/访问共享目录/访问NFS共享目录.md#)。

