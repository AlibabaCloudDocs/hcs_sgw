# 管理SMB共享 {#concept_108274_zh .task}

本文介绍如何在本地文件网关控制台上管理SMB共享，包括创建/删除/关闭/修改SMB共享、设置AD/LDAP、添加SMB用户等操作。

1.  已添加缓存，详情请参见[添加缓存](cn.zh-CN/本地控制台用户指南/文件网关/管理缓存.md#section_1fm_vtm_6a7)。
2.  已绑定云资源，详情请参见[绑定云资源](cn.zh-CN/本地控制台用户指南/文件网关/管理云资源.md#section_4tc_gc9_08v)。

SMB（Server Message Block，用于Web连接和客户端与服务器之间的信息沟通的协议）是面向网络连接的共享协议，用于实现文件共享功能。它使用客户端/服务器模式。

云存储网关作为SMB的服务器端提供文件共享服务。您在Windows操作系统的客户端上进行访问，云存储网关将获得客户端请求并返回响应。

使用云存储网关SMB服务，您需要先在云存储网关上配置共享目录以及能访问这个目录的用户和访问权限。

## 创建SMB共享 {#section_24y_qfz_s0r .section}

1.  在浏览器中，输入`https://<文件网关IP地址>`访问本地文件网关控制台。
2.  输入用户名和密码，单击**确认**。
3.  选择**SMB**，单击**创建**。
4.  在创建SMB对话框中，完成如下配置。 

    |参数|说明|
    |--|--|
    |**共享名称**|SMB共享名称。|
    |**只读权限用户**|允许只读访问SMB网关的用户列表。|
    |**读写权限用户**|允许读写访问SMB网关的用户列表。|
    |**启用**|启用SMB共享。 如果您暂时不想使用该SMB共享，您可以选择**否**，关闭该SMB共享。

 |
    |**可浏览**|可在网络邻居被发现。|
    |**模式**|包括缓存模式和复制模式。     -   **复制模式**：所有数据都会保存两份拷贝，一份保存在本地缓存，另一份保存在OSS。
    -   **缓存模式**：本地缓存全量元数据和经常访问的用户数据。OSS侧保持全量数据。
 |
    |**反向同步**|将OSS上的元数据同步回本地。适用于网关容灾和数据恢复/共享场景。 **说明：** 反向同步会扫描Bucket下的所有对象，如果对象数量较多，会产生OSS API请求费用。具体费用，请参见[对象存储 OSS 详细价格信息](https://www.aliyun.com/price/product?spm=a2c4g.11186623.2.26.18277b55Ki5BVd#/oss/detail)中的请求费用。

 |
    |**加密类型**|包括**不加密**和**服务端加密**。 如果选择**服务端加密**，还需设置**密钥ID**。您可以在[密钥管理服务控制台](https://kms.console.aliyun.com/)[密钥管理服务控制台](partners-intl.console.aliyun.com/#/kms)中创建密钥，详情请参见[创建密钥](../../../../cn.zh-CN/快速入门/管理密钥.md#section_yhn_otu_mvs)。

 开启OSS服务端加密后，允许用户自带密钥，目前支持从密钥管理服务中导入KMS密钥。

 开启服务端加密后，通过共享目录上云的文件会在OSS端自动利用KMS密钥进行加密。您可以通过Get Object API验证当前文件是否已经加密，如果返回的Header中x-oss-server-side-encryption字段值为KMS，x-oss-server-side-encryption-key-id字段值为密钥ID，则表示已加密。

 **说明：** 

    -   白名单用户才能使用此功能。
    -   在密钥管理服务控制台创建密钥时，需选择与OSS Bucket一样的区域。
 |
    |**Bucket名称**|选择已创建的Bucket。|
    |**子目录**|输入Bucket下的子目录。 子目录只支持英文和数字。

 **说明：** 从1.0.38版本开始支持将文件系统的根目录对接到OSS Bucket的某个子目录，便于用户做访问隔离。

子目录可以为OSS Bucket中已存在的目录也可以为OSS Bucket中还未创建的目录，创建共享完成后，将以该子目录为根目录，后续的文件和目录都会创建该目录下。

 |
    |**使用元数据盘**|使用元数据盘后，将数据盘与元数据盘分离，元数据盘用于存放共享文件夹元数据信息。     -   选择**是**，需选择对应的**元数据盘**和**数据盘**。
    -   选择**否**，需选择对应的**缓存路径**。
 **说明：** 白名单用户才能使用此功能。

 |
    |**忽略删除**|文件删除操作不同步至OSS防止误操作。OSS侧保持全量数据。|
    |**同步延迟**|设置**同步延迟**，在关闭文件会延迟一段时间再上传，防止频繁的本地修改操作造成OSS碎片。缺省值为5s，最大值120s。|
    |**最大写入速度**|允许的最大写入速度为1280MB/s。默认为0，表示不限制速度。|
    |**最大上传速度**|允许的最大上传速度为1280MB/s。默认为0，表示不限制速度。 **说明：** 在限制速度的情况下，最大上传速度不能小于最大写入速度。

 |
    |**碎片优化**|针对某些反复随机小IO读写的应用，启用此配置可提升性能，请根据场景谨慎选择。|
    |**上传优化**|实时缓存回收，适用于数据纯备份上云场景。|


## AD/LADP介绍 {#section_blz_bfx_fud .section}

活动目录（AD）与轻量级目录访问协议（LDAP）是标准的应用协议，用于在互联网协议（IP）网络中，访问与更改目录服务的数据。选择您想要加入的AD服务或LDAP服务进行配置。

-   完成DNS服务器配置后，才能加入AD。
-   AD和LDAP不能同时加入。
-   当前AD域用户/LDAP用户/本地用户同时只能生效一种。在加入/离开AD域或者连接/断开LDAP服务器时，会自动删除CIFS共享中已配置的用户权限。
-   AD功能支持的服务器版本：64位Windows Server 2016数据中心版、Windows Server 2012 R2数据中心版。
-   LDAP功能支持的服务器版本：基于64位CentOS 7.4的openldap server 2.4.44。

## 配置AD {#section_u13_inm_kcj .section}

1.  设置DNS服务器。 
    1.  在本地网关控制台中，单击**关于**。
    2.  找到网络配置区域，单击**切换DNS服务器**。
    3.  在切换DNS服务器对话框中，添加DNS服务器，单击**确认**。 在**DNS服务器**框中，添加AD Server的IP地址，用来解析AD域名。
2.  加入AD。 
    1.  选择**SMB** \> **AD/LDAP**。
    2.  在Windows活动目录（AD）区域，单击**加入AD**。
    3.  在加入Windows活动目录（AD）对话框中，完成如下配置并单击**确认**。 

        -   **服务器IP**：输入AD服务器的IP地址。
        -   **用户名**：输入管理员用户名。
        -   **密码**：输入管理员密码。
        连接成功后，Windows活动目录（AD）区域中的**已连接**显示为**是**。

        **说明：** 加入Windows活动目录（AD）后，当前SMB共享里配置的本地用户权限将被移除。


## 配置LDAP {#section_oyc_2al_mbx .section}

1.  在本地网关控制台中，选择**SMB** \> **AD/LDAP**。
2.  在轻量目录访问协议（LDAP）区域，单击**加入LDAP**。
3.  在连接LDAP服务器对话框中，完成如下配置并单击**确认**。 

    -   **服务器IP**：输入LDAP服务器的IP地址（目录系统代理）。
    -   **TLS支持**：指定系统与LDAP服务器通信的方式。
    -   **Base DN**：指定LDAP域，例如：dc=iftdomain,dc=ift.local。
    -   **Root DN**：指定LDAP根，例如：cn=admin, dc=iftdomain,dc=ift.local。
    -   **密码**：输入根目录密码。
    连接成功后，轻量目录访问协议（LDAP\)区域中的**已连接**显示为**是**。

    **说明：** 加入轻量目录访问协议后，当前SMB共享里配置的本地用户权限将被移除。


## 添加SMB用户 {#section_wlr_34s_n7g .section}

在未加入任何域的情况下，您可创建SMB用户用于访问云存储网关。

-   如果已加入AD域，在SMB用户页面，会显示所有的AD用户。
-   如果已加入LDAP域，在SMB用户页面，会显示所有配置了Samba密码的LDAP用户。
-   如果已加入LDAP域但未配置Samba密码，您可在**SMB用户**页面，单击**创建**，为LDAP用户添加Samba密码。

    建议Samba密码与LDAP密码设置一致。


1.  在本地网关控制台中，选择**SMB** \> **SMB用户**。
2.  单击**创建**。
3.  在添加SMB用户对话框中，配置名称和密码。
4.  单击**确认**，完成创建。

## 相关操作 {#section_37w_9sz_4h7 .section}

在SMB页面，您还可以进行如下配置。

|操作|说明|
|--|--|
|关闭SMB共享|在SMB页面中，单击页面左上角的关闭按钮，关闭SMB共享。 如果您想关闭单个SMB共享，可通过以下方式。

 在SMB列表页签中，找到目标SMB共享，单击**设置**，将**启动**选项设置为**否**。

 |
|删除SMB共享|在SMB列表页签中，找到目标SMB共享，单击**删除**，删除该SMB共享。 **说明：** 删除SMB共享后，windows挂载点或者映射的网络驱动器会立即失效。

 |
|修改SMB共享|在SMB列表页签中，找到目标SMB共享，单击**设置**或**高级设置**，修改SMB共享。|
|缓存刷新|在SMB列表页签中，找到目标SMB共享，单击**缓存刷新**，刷新缓存。|
|删除SMB用户|在SMB用户页签中，找到目标用户，单击**删除**，删除SMB用户。|
|关闭连接|在AD/LDAP页签中，单击**关闭连接**，可关闭AD或LDAP连接。|

[访问SMB共享目录](../../../../cn.zh-CN/本地控制台用户指南/文件网关/访问共享目录/访问SMB共享目录.md#)

